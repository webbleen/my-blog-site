---
layout: post
title: "centos6.x 部署redmine-3.3.3+nginx"
date: 2018-06-19 16:28:00.000000000 +16:00
tags: 操作文档集
---



**安装前提条件**

centOs 6.x，详见：[http://www.redmine.org/projects/redmine/wiki/RedmineInstall](http://www.redmine.org/projects/redmine/wiki/RedmineInstall)

| Redmine version | Supported Ruby versions               | Rails version used |
| --------------- | ------------------------------------- | ------------------ |
| 4.0 (upcoming)  | ruby 2.2(2.2.2 and later), 2.3, 2.4   | Rails 5.1          |
| 3.4             | ruby 1.9.3, 2.0.0, 2.1, 2.2, 2.3, 2.4 | Rails 4.2          |
| 3.3             | ruby 1.9.3, 2.0.0, 2.1, 2.2, 2.3      | Rails 4.2          |
| 3.2             | ruby 1.9.3, 2.0.0, 2.1, 2.2           | Rails 4.2          |



**需要的基础库**

```bash
$ yum -y install libyaml-devel zlib-devel curl-devel openssl-devel httpd-devel apr-devel apr-util-devel gcc ruby-devel gcc-c++ make postgresql-devel ImageMagick-devel sqlite-devel mysql-devel perl-LDAP mod_perl perl-Digest-SHA libcurl libcurl-devel libiconv libiconv-devel libxml2 libxml2-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libmcrypt libmcrypt-devel pcre pcre-devel
```



**从redmine官网下载 redmine：[http://www.redmine.org/releases/redmine-3.3.3.tar.gz](http://www.redmine.org/releases/redmine-3.3.3.tar.gz)**

解压后安装 
```bash
$ ./configure && make && make install
```



**配置gem镜像源[http://gems.ruby-china.org/](http://gems.ruby-china.org/)**

```bash
$ gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/
```
```bash
$ gem sources -l
```
https://gems.ruby-china.org #确保只有 gems.ruby-china.org



**安装Passenger（用于整合Nginx）**

```bash
$ gem install passenger
```
```bash
$ passenger-install-nginx-module
```
按照提示步骤一步步操作



**安装框架rails**

```bash
$ gem install rails -v=4.2.7.1
```



**安装redmine的依赖库**

安装bundler 工具 参考第2条修改bundler镜像源

```bash
$ bundle config mirror.https://rubygems.org https://gems.ruby-china.org
```
```bash
$ gem install bundler
```
解压redmine后在redmine-3.3.3/下面执行 
```bash
$ bundle install
```



**修改配置文件并初始化数据库和数据**

创建数据库

```mysql
CREATE DATABASE IF NOT EXISTS redmine DEFAULT CHARSET utf8;
CREATE DATABASE IF NOT EXISTS redmine_development DEFAULT CHARSET utf8;
CREATE DATABASE IF NOT EXISTS redmine_test DEFAULT CHARSET utf8;
```

配置文件为config/database.yml

```properties
# Default setup is given for MySQL with ruby1.9.
# Examples for PostgreSQL, SQLite3 and SQL Server can be found at the end.
# Line indentation must be 2 spaces (no tabs).

production:
  adapter: mysql2
  database: redmine
  host: localhost
  username: root
  password: "****"
  encoding: utf8

development:
  adapter: mysql2
  database: redmine_development
  host: localhost
  username: root
  password: "****"
  encoding: utf8

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  adapter: mysql2
  database: redmine_test
  host: localhost
  username: root
  password: "****"
  encoding: utf8
```

为Rails生成cookies秘钥
```bash
$ rake generate_secret_token
```
创建数据库结构
```bash
$ RAILS_ENV=production rake db:migrate
```
生成缺省数据
```bash
$ RAILS_ENV=production REDMINE_LANG=zh rake redmine:load_default_data
```



**配置nginx.conf**

```properties
server {
            listen       3000;
            listen       localhost:3000;
            # server_name  somename  alias  another.alias;
    
            location / {
            root   /var/www/html/redmine/public;
            passenger_enabled on;
            index  index.html index.htm;
    }
}
```

安装期间可能碰到库或者软件版本不兼容的问题，需要逐个排查。



**其他**



- 页面优化

  优化点：

1. 页面字体大小
2. 邮件内容字体大小
3. 右边栏目宽度
4. 列表行高调整
5. 主题宽度限制，超出部分显示‘...’，鼠标放上显示完整内容

![redmine-issue-list](/assets/images/2018/redmine-issue-list.png)
(截图仅供参考)



邮件字体大小调整

修改：

```properties
# 邮件字体大小调整
# 文件：app\views\layouts\mailer.html.erb
# 第6行
font-size: 0.8em; 
# 改为：
font-size: 14px;
# 其它

# 文件：/opt/redmine-3.0.0-0/apps/redmine/htdocs/public/stylesheets/application.css
# 第2行
body { font-family: Verdana, sans-serif; font-size: 12px; color:#484848; margin: 0; padding: 0; min-width: 900px; }
# 修改为
body { font-family: 微软雅黑,Verdana, sans-serif; font-size: 13px; color:#484848; margin: 0; padding: 0; min-width: 900px; }

# 第73行
#sidebar{ float: right; width: 22%; position: relative; z-index: 9; padding: 0; margin: 0;}
# 修改为
#sidebar{ float: right; width: 12%; position: relative; z-index: 9; padding: 0; margin: 0;}

# 第127行
table.list td {text-align:center; vertical-align:top; padding-right:10px;}
# 改成
table.list td {text-align:center; vertical-align:middle; padding-right:10px;}

# 第131行
table.list td.checkbox { width: 15px; padding: 2px 0 0 0; }
# 修改为
table.list td.checkbox { width: 15px; padding: 2px 0 0 0;height: 30px; }

# 第155行
tr.issue td.subject, tr.issue td.category, td.assigned_to, tr.issue td.string, tr.issue td.text, tr.issue td.relations, tr.issue td.parent { white-space: normal; }
# 修改为
/**************change***************/
tr.issue td.subject, tr.issue td.category, td.assigned_to, tr.issue td.string, tr.issue td.text, tr.issue td.relations, tr.issue td.parent { white-space: nowrap;text-align: justify;word-break:break-all; }
tr.issue td.subject{
 width: 260px;
}
tr.issue td.subject a{
  display: block;
  overflow:hidden;
  width: 300px;
  text-overflow:ellipsis;
  text-align: left;
}
/**************end change***************/

# 文件：/opt/redmine-3.0.0-0/apps/redmine/htdocs/public/javascripts/ application.js
# 在651行后追加
$(function(){
	$('tr.issue td.subject a').each(function(i){
	      $(this).attr('title',$(this).html());
	});
});
```